@model IEnumerable<Tree.API.Models.Node>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Index";
}

    <head>
        <link href="~/Styles/test.css" rel="stylesheet" type="text/css" />

        <link href="~/Styles/all.min.css" rel="stylesheet">
        <link href="~/Styles/fontawesome.min.css" rel="stylesheet" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>



        <script>

            function usuwanie(obj) {
                console.log("usuwanie 1");
                console.log(obj);
                for (var i = 0; i < obj.length; i++) {
                    if (obj[i].children) {
                        console.log("w if");
                        usuwanie(obj[i].children);
                    }
                    var Id = obj[i].id;

                    $.ajax({
                        type: 'DELETE',
                        url: 'https://localhost:44366/value/' + Id,
                        dataType: 'json',
                        contentType: 'application/json; charset=utf-8',

                    });
                }
            }








            function usuwanieFirst(table, id) {
                console.log("usuwaniefirst");
                console.log(table);
                console.log(id);
                console.log(table.length);
                
                for (var i = 0; i < table.length; i++) {
                    console.log(table[i].children);
                    if (table[i].id == id) {
                        console.log(table[i].Id);
                        if (table[i].children != null) {
                                  usuwanie(table[i].children);
                        }

                  
                    }
                }
                console.log("Koniec");
            }


            
            function usuwanieLast( id) {
              
                 $.ajax({
                        type: 'DELETE',
                        url: 'https://localhost:44366/value/' + id,
                        dataType: 'json',
                     contentType: 'application/json; charset=utf-8',
                     success: function (result) {
                       
                                       
                                    },


                    });
            }












            function combobox() {

                $.ajax({
                                    type: 'GET',
                                    url: 'https://localhost:44366/value/allElemennts' ,
                                    dataType: 'json',
                                    contentType: 'application/json; charset=utf-8',
                                     success: function (data) {

                                        $('#ParentId').empty();
                                         var s = $('#ParentId');
                                         
                                         for (var val in data) {
                                             $('<option />', { value: val.id, text: data[val].id}).appendTo(s);
                                           }

                                    }
                                });
            }



            combobox();


            function rozwin() {
                var toggler = document.getElementsByClassName("caret");
                var i;
       
                for (i = 0; i < toggler.length; i++) {

                toggler[i].parentElement.querySelector(".nested").classList.toggle("active");
                toggler[i].classList.toggle("caret-down");
       
        }

                var s = $("#rozwiń").text();
                if (s == 'Rozwin') {
                    $("#rozwin").text("Zwin");
                }
                else {
                    $("#rozwin").text("Rozwin");
                }

            }

            function sortBranch() {
                $(document).ready(function () {
                    $("#")
                })
            }

            function time() {
                $(document).ready(function () {
                    $("i").click(function (e) {
                        
                        var check = event.target.id + "a";
                        var setid = $("#" + check).val();
                          console.log("setid");
                        console.log(setid);
                        var temp = setid + "da";
                        var temp2 = setid + "sa";
                        var temp3 = setid + "fa";

                  
                        var Id = setid;
                        if (temp == check) {


                            if (confirm("Are you sure?")) {


                                $.ajax({
                                    type: 'GET',
                                    url: 'https://localhost:44366/value/full',
                                    dataType: 'json',
                                    contentType: 'application/json; charset=utf-8',
                                    success: function (data) {
                                        alert("tujaj bylem");

                                        usuwanieFirst(data, Id);

                                        console.log("Wrocilem tu");
                                        usuwanieLast(Id);


                                        $("#tree").empty();


                                        setTimeout(() => renderTree(), 400);
                                        setTimeout(() => testowa(), 500);
                                        setTimeout(() => time(), 800);
                                        setTimeout(() => combobox(), 1000);
                                        setTimeout(() => rozwin(), 1001);

                                    }
                                });


                                //        $.ajax({
                                //            type: 'DELETE',
                                //            url: 'https://localhost:44366/value/' + Id,

                                //            success: function (result) {
                                //                $("#tree").empty();
                                //                 alert("Sukces");
                                //renderTree();
                                //setTimeout(() => testowa(), 500);
                                //setTimeout(() => time(), 800);
                                //setTimeout(() => combobox(), 1000);
                                //setTimeout(() => rozwin(), 1001);

                                //            },
                                //             error: function(result) {
                                //               alert('error');
                                //               }
                                //        });


                            }
                        }
                        else if (temp2 == check) {
                            $.ajax({
                                type: 'GET',
                                url: 'https://localhost:44366/value/' + Id,
                                dataType: 'json',
                                contentType: 'application/json; charset=utf-8',
                                success: function (data) {
                                    alert("Get metoda");
                       
                                     $("#Name").val(data.name);
                                    $("#ParentId").val(data.parentId);
                                    $("#Id").val(data.id);

                                }
                            });



                        }
                        else {
                            var idsort = event.target.id + "a";
                            var valsortid = $("#" + idsort).val();
                           
                            $("#tree").empty();
                            renderTreeSortBranch(valsortid);
                        }

                    });
                });
            }



        

           
           



            setTimeout(() => time(), 1000);

            function getElemById(i) {

                  $.ajax({
                                    type: 'GET',
                                    url: 'https://localhost:44366/value/full',
                                    dataType: 'json',
                                    contentType: 'application/json; charset=utf-8',
                                     success: function (data) {
                                         $("#Name").val(data.name);
                                         
                                         $("#ParentId").val(data.parentId);
                                         $("#Id").val(data.id);
                                         alert(data[i].children);
                                         
                                    }
                                });
            }
        </script>
    </head>
    <body>

        <div id="tree"></div>



        <script>



            function add() {
                id = $("#id").val();
                name = $("#Name").val();
                parentId = $("#ParentId").val();
                var data = {
                    "Id": id,
                    "Name": name,
                    "ParentId": parentId
                };



                $.ajax({
                    type: 'POST',
                    url: 'https://localhost:44366/value/',
                    dataType: 'json',
                    data: JSON.stringify(data),
                    contentType: 'application/json; charset=utf-8',
                    success: function (result) {
                        $("#tree").empty();
                        renderTree();
                        setTimeout(() => testowa(), 1002);
                        setTimeout(() => time(), 800);
                        setTimeout(() => combobox(), 1000);
                        setTimeout(() => rozwin(), 1001);

                    }
                });
            }



            function getElemById(Id) {



                $.ajax({
                    type: 'GET',
                    url: 'https://localhost:44366/value/' + Id,
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {
                        $("#Name").val(data.name);

                        $("#ParentId").val(data.parentId);
                        $("#Id").val(data.id);
                    }
                });
            }


            function change() {
                id = $("#Id").val();
                name = $("#Name").val();
                parentId = $("#ParentId").val();
                var data = {
                    "Id": id,
                    "Name": name,
                    "ParentId": parentId
                };



                $.ajax({
                    type: 'PUT',
                    url: 'https://localhost:44366/value/',
                    dataType: 'json',
                    data: JSON.stringify(data),
                    contentType: 'application/json; charset=utf-8',
                    success: function (result) {
                        $("#tree").empty();
                        alert("Sukces");
                        renderTree();
                        setTimeout(() => testowa(), 1002);
                        setTimeout(() => time(), 800);
                        setTimeout(() => combobox(), 1000);
                        setTimeout(() => rozwin(), 1001);


                        $("#Id").val(0);
                        $("#Name").val("");
                        $("#ParentId").val(1);
                    }
                });
            }



            function to_uld(temp) {

                for (var i = 0, n = temp.length; i < n; i++) {
                    var child = temp[i];
                    var test = document.getElementById(child.id + "s");
                 
                    if (test == null) {


                        document.getElementById(child.id).innerHTML += "   <i id=" + child.id + "s class=\"fas fa-tools\"><input id=" + child.id + "sa type=\"hidden\" value=" + child.id + "></i>";
                        document.getElementById(child.id).innerHTML += "   <i  id=" + child.id + "d class=\"fa fa-trash\" aria-hidden=\"true\"><input id=" + child.id + "da type=\"hidden\" value=" + child.id + "></i></i>";

                    }
                    else {
                        document.getElementById(child.id + "s").innerHTML += "  <i id=" + child.id + "s  class=\"fas fa-tools\"><input id=" + child.id + "sa type=\"hidden\" value=" + child.id + "></i>";
                        document.getElementById(child.id + "s").innerHTML += "    <i  id=" + child.id + "d class=\"fa fa-trash\" aria-hidden=\"true\"><input id=" + child.id + "da type=\"hidden\" value=" + child.id + "></i></i>";
                        document.getElementById(child.id + "s").innerHTML += "   <i  id=" + child.id + "f class=\"fa fa-filter\" aria-hidden=\"true\"><input id=" + child.id + "fa type=\"hidden\" value=" + child.parentId + "></i></i>";
                    }

                    if (child.children) {
                        to_uld(child.children);
                    }


                }


            }


            function dynamicSort(property) {
    var sortOrder = 1;
    if(property[0] === "-") {
        sortOrder = -1;
        property = property.substr(1);
    }
    return function (a,b) {
        /* next line works with strings and numbers, 
         * and you may want to customize it to your needs
         */
        var result = (a[property] < b[property]) ? -1 : (a[property] > b[property]) ? 1 : 0;
        return result * sortOrder;
    }
}



            function to_ul(temp, obj) {

                var ul = document.createElement("ul");
                if (obj.name != "root") {
                    ul.className = "nested";
                }
                if (obj.name == 'root') {
                    ul.id = "myUL";
                    var liroot = document.createElement("li");
                    var uln = document.createElement("ul");
                    var spanroot = document.createElement("span")
                    var sg = document.createTextNode("Tree");
                    spanroot.className = "caret";

                    spanroot.appendChild(sg);
                    uln.className = "nested";
                    ul.appendChild(liroot);
                    liroot.appendChild(spanroot);
                    liroot.appendChild(uln);

                }
               
                for (var i = 0, n = temp.length; i < n; i++) {
                    var child = temp[i];
                    var li = document.createElement("li");
                    var button = document.createElement("a");
                    var button2 = document.createElement("a");
                    var spanek = document.createElement("span");
                    spanek.className = "caret";
                   
                    li.id = child.id;
                    spanek.id = child.id + "s";
                    button.id = child.id + "a";
                    button2.id = child.id + "t";

                    var y = document.createTextNode("<i class=\"fas fa-plus-circle\"></i>");
                    button2.href = "www.google.pl"
                    button.href = "https://localhost:44366/value/test";
                    button.appendChild(y);
                    var text = document.createTextNode(child.name);


                    if (child.children) {
                        spanek.appendChild(text);
                        li.appendChild(spanek);
                        li.appendChild(to_ul(child.children, child.name));
                    }
                    else {
                        li.appendChild(text);

                    }
                    if (obj.name == 'root') {

                        uln.appendChild(li);
                    }
                    else {
                        ul.appendChild(li);
                        var at = child.id + "a";
                    }
                }

                return ul;
            }

            async function renderTree() {
                var treeEl = document.getElementById("tree");
                const api_url = 'https://localhost:44366/value/all';

                const response = await fetch(api_url);
                const data = await response.json();



                var treeObj = data;

              
                treeEl.appendChild(to_ul(treeObj.children, treeObj));
                to_uld(treeObj.children);
            }


            async function renderTreeSortBranch(id) {
                var treeEl = document.getElementById("tree");
                const api_url = 'https://localhost:44366/value/all';

                const response = await fetch(api_url);
                const data = await response.json();



                var treeObj = data;

              
                treeEl.appendChild(to_ulSortBranch(treeObj.children, treeObj, id));
                to_uld(treeObj.children);
            }

                function to_ulSortBranch(temp, obj, id) {

                var ul = document.createElement("ul");
                if (obj.name != "root") {
                    ul.className = "nested";
                }
                if (obj.name == 'root') {
                    ul.id = "myUL";
                    var liroot = document.createElement("li");
                    var uln = document.createElement("ul");
                    var spanroot = document.createElement("span")
                    var sg = document.createTextNode("Tree");
                    spanroot.className = "caret";

                    spanroot.appendChild(sg);
                    uln.className = "nested";
                    ul.appendChild(liroot);
                    liroot.appendChild(spanroot);
                    liroot.appendChild(uln);

                }

                   
               
                console.log(temp);

                for (var i = 0, n = temp.length; i < n; i++) {
                    var child = temp[i];
                    var li = document.createElement("li");
                    var button = document.createElement("a");
                    var button2 = document.createElement("a");
                    var spanek = document.createElement("span");
                    spanek.className = "caret";
                   
                    li.id = child.id;
                    spanek.id = child.id + "s";
                    button.id = child.id + "a";
                    button2.id = child.id + "t";

                    var y = document.createTextNode("<i class=\"fas fa-plus-circle\"></i>");
                    button2.href = "www.google.pl"
                    button.href = "https://localhost:44366/value/test";
                    button.appendChild(y);
                    var text = document.createTextNode(child.name);


                    if (child.children) {
                        console.log("Dzieci");
                        console.log(child.id);
                        console.log(id);
                        spanek.appendChild(text);
                        li.appendChild(spanek);
                        if (child.id == id) {
                            console.log(child.cs);
                            console.log(child.children.sort(dynamicSort("name")));
                        }
                        li.appendChild(to_ul(child.children.sort(dynamicSort("name")), child.name, id));
                    }
                    else {
                        li.appendChild(text);

                    }
                    if (obj.name == 'root') {

                        uln.appendChild(li);
                    }
                    else {
                        ul.appendChild(li);
                        var at = child.id + "a";
                    }
                }

                return ul;
            }


            async function testowa() {
                var toggler = document.getElementsByClassName("caret");
                var i;
               

                for (i = 0; i < toggler.length; i++) {
                    toggler[i].addEventListener("click", function () {
                        this.parentElement.querySelector(".nested").classList.toggle("active");
                        this.classList.toggle("caret-down");
                    });
                }




            }

            renderTree();
            setTimeout(() => testowa(), 1000);

        </script>
        <script>
            document.addEventListener("DOMContentLoaded", function (event) {

                var toggler = document.getElementsByClassName("caret");
           

            });
         
        </script>

        <button id="rozwin" onclick="rozwin()">Rozwiń</button>
        <br />
        <input type="hidden" id="Id" value="0" />
        <input type="text" id="Name" />
        <br />
        <select id="ParentId">
        </select>

        <br />
        <button id="tes\\t" onclick="add()">Dodaj</button>
        <button id="tes\\t" onclick="change()">Edytuj</button>


        <p id="00">tekst</p>
       

    </body>